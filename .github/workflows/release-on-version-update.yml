# .github/workflows/release-on-version-update.yml
name: Build & Release when version changes

on:
  push:
    branches: [main]
    paths: # manifest.json ãŒå¤‰æ›´ã•ã‚ŒãŸ push ã§ã®ã¿èµ·å‹•
      - "manifest.json"

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # 1) ãƒªãƒã‚¸ãƒˆãƒªå–å¾—ï¼ˆå±¥æ­´ 1 ã¤å‰ã¾ã§å¿…è¦ãªã®ã§ fetch-depth 0ï¼‰
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Node & Yarn ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä»˜ãã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - uses: actions/setup-node@v4
        with:
          node-version: 20 # å¿…è¦ã«å¿œã˜ã¦å¤‰æ›´
          cache: yarn

      # 3) ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: yarn install --frozen-lockfile

      # 4) ç¾åœ¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³å–å¾—
      - name: Read current version
        id: version
        run: |
          echo "version=$(jq -r .version manifest.json)" >> "$GITHUB_OUTPUT"

      # 5) 1ã¤å‰ã®ã‚³ãƒŸãƒƒãƒˆã¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¯”è¼ƒ
      - name: Detect version change
        id: changed
        run: |
          CUR="${{ steps.version.outputs.version }}"
          PREV=$(git show HEAD^:manifest.json | jq -r .version 2>/dev/null || echo "")
          echo "prev_version=$PREV"  >> "$GITHUB_OUTPUT"
          echo "changed=$([ "$CUR" != "$PREV" ] && echo true || echo false)" >> "$GITHUB_OUTPUT"

      # 6) ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤‰ã‚ã‚‰ãªã‘ã‚Œã°ã‚¸ãƒ§ãƒ–çµ‚äº†
      - name: Skip if unchanged
        if: steps.changed.outputs.changed == 'false'
        run: |
          echo "Version unchanged (${{ steps.version.outputs.version }}). Skip build."
          exit 0

      # 7) ãƒ“ãƒ«ãƒ‰
      - name: Build project
        if: steps.changed.outputs.changed == 'true'
        run: yarn build # â† package.json ã® build ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ

      # 8) dist ã‚’ zip åŒ–ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³å.zipï¼‰
      - name: Zip dist directory
        if: steps.changed.outputs.changed == 'true'
        run: |
          cd dist
          zip -r "../${{ steps.version.outputs.version }}.zip" .
          cd ..

      # 9) Git ã‚¿ã‚°ã‚’ä½œæˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
      - name: Set up Git config and push tag
        if: steps.changed.outputs.changed == 'true'
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ steps.version.outputs.version }}" -m "Release v${{ steps.version.outputs.version }}"

          # ğŸ”‘ Set authenticated remote using GITHUB_TOKEN
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}

          git push origin "v${{ steps.version.outputs.version }}"

      # 10) GitHub Release ã‚’ä½œæˆã— zip ã‚’æ·»ä»˜
      - name: Create GitHub Release
        if: steps.changed.outputs.changed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          files: ${{ steps.version.outputs.version }}.zip
          fail_on_unmatched_files: true # zip ãŒç„¡ã„å ´åˆã¯å¤±æ•—
